<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>í”½ì…€ í« í•˜ìš°ìŠ¤ V4</title>
    <style>
        body {
            margin: 0; background-color: #222; color: white;
            font-family: 'Courier New', monospace;
            display: flex; height: 100vh; overflow: hidden; user-select: none;
        }
        #main-container { display: flex; width: 100%; height: 100%; }
        #editor-panel {
            width: 400px; background-color: #333; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            border-right: 4px solid #111;
        }
        #game-panel { flex-grow: 1; display: flex; flex-direction: column; background-color: #444; position: relative; }
        
        /* ìƒë‹¨ ë°” */
        #stats-bar {
            height: 60px; background: #222; display: flex; align-items: center; justify-content: space-around;
            padding: 0 20px; border-bottom: 4px solid #111; font-weight: bold; position: relative;
        }
        .stat-box { display: flex; align-items: center; gap: 10px; }
        progress { width: 120px; height: 15px; border: 2px solid #555; background: #333; }
        progress::-webkit-progress-bar { background: #333; }
        progress::-webkit-progress-value { transition: width 0.5s; }
        #hunger-bar::-webkit-progress-value { background: #ff9f43; }
        #clean-bar::-webkit-progress-value { background: #54a0ff; }

        /* ë„ì›€ë§ ë²„íŠ¼ */
        #btn-help {
            background: #6c5ce7; color: white; border: 2px solid white;
            border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold;
        }

        /* ë„ì›€ë§ íŒì—… (ë§¤ë‰´ì–¼) */
        #help-modal {
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; background: white; color: #333;
            border: 4px solid #6c5ce7; border-radius: 15px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100;
        }
        #help-modal h3 { margin-top: 0; text-align: center; color: #6c5ce7; }
        .manual-item { margin-bottom: 10px; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .manual-icon { font-size: 20px; width: 30px; text-align: center; }
        #btn-close-help {
            display: block; width: 100%; padding: 10px; margin-top: 20px;
            background: #6c5ce7; color: white; border: none; font-weight: bold; cursor: pointer;
        }

        /* ë°© */
        #room-container {
            flex-grow: 1; position: relative; background-color: #c7ecee;
            display: flex; justify-content: center; align-items: center;
        }
        #roomCanvas {
            background-color: #f7f1e3; border: 4px solid #84817a;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            cursor: grab; image-rendering: pixelated;
        }
        #roomCanvas:active { cursor: grabbing; }

        /* í•˜ë‹¨ ë²„íŠ¼ */
        #actions-bar {
            height: 80px; background: #222; display: flex; align-items: center; justify-content: center;
            gap: 20px; border-top: 4px solid #111;
        }
        .action-btn {
            padding: 10px 20px; font-size: 16px; font-weight: bold;
            border: 3px solid #111; border-radius: 10px; cursor: pointer;
            background: #eee; color: #222; box-shadow: 0 4px 0 #111; transition: all 0.1s;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        #btn-feed { background: #ff9f43; } #btn-buy { background: #ffd700; }

        /* ì—ë””í„° ìŠ¤íƒ€ì¼ */
        h2 { margin: 5px 0; color: #ffd700; }
        #editorCanvas {
            background-color: white; border: 4px solid #000; cursor: crosshair; image-rendering: pixelated;
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%); background-size: 10px 10px;
        }
        .toolbar { display: flex; gap: 5px; margin: 8px 0; background: #222; padding: 5px; border-radius: 8px; }
        .tool-btn { background: #555; border: 2px solid #222; color: white; padding: 5px 10px; cursor: pointer; }
        .tool-btn.active { background: #ffd700; color: black; }
        #palette { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; margin: 8px 0; background: #222; padding: 5px; }
        .color-btn { width: 25px; height: 25px; border: 2px solid #666; cursor: pointer; }
        .color-btn.active { border: 2px solid white; transform: scale(1.1); }
        .editor-controls { margin-top: 10px; display: flex; gap: 10px; }
    </style>
</head>
<body>

<div id="main-container">
    <div id="editor-panel">
        <h2 id="editor-title">ğŸ¨ í« ê·¸ë¦¬ê¸°</h2>
        <div class="toolbar">
            <button class="tool-btn active" id="btn-pencil" onclick="setTool('pencil')">âœï¸</button>
            <button class="tool-btn" id="btn-eraser" onclick="setTool('eraser')">ğŸ§½</button>
            <button class="tool-btn" id="btn-bucket" onclick="setTool('bucket')">ğŸª£</button>
            <div style="width:1px; height:20px; background:#666; margin:0 5px;"></div>
            <button class="tool-btn" onclick="undo()">â†©ï¸</button>
            <button class="tool-btn" onclick="clearCanvas()">ğŸ—‘ï¸</button>
        </div>
        <canvas id="editorCanvas" width="64" height="64" style="width: 320px; height: 320px;"></canvas>
        <div id="palette"></div>
        <div class="editor-controls">
            <button class="action-btn" id="btn-save-pet" onclick="savePet()" style="background:#ffd700;">âœ¨ íƒ„ìƒì‹œí‚¤ê¸°</button>
            <button class="action-btn" id="btn-save-furniture" onclick="saveFurniture()" style="display:none; background:#c7ecee;">ğŸª‘ ê°€êµ¬ ì™„ì„±</button>
            <button class="action-btn" id="btn-cancel-furniture" onclick="cancelFurnitureMode()" style="display:none; background:#ff6b6b;">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="game-panel">
        <div id="help-modal">
            <h3>ğŸ“– ê²Œì„ ì„¤ëª…ì„œ</h3>
            <div class="manual-item"><span class="manual-icon">ğŸ–</span> <strong>ë°¥ ì£¼ê¸°:</strong> [ë°¥ ì¤€ë¹„] í´ë¦­ í›„ ê³ ê¸°ë¥¼ í«ì—ê²Œ ë“œë˜ê·¸í•˜ì„¸ìš”.</div>
            <div class="manual-item"><span class="manual-icon">ğŸ›</span> <strong>ì”»ê¸°ê¸°:</strong> í«ì„ ì¡ì•„ì„œ(ë“œë˜ê·¸) ì˜¤ë¥¸ìª½ ì•„ë˜ ìš•ì¡°ì— ë„£ìœ¼ì„¸ìš”.</div>
            <div class="manual-item"><span class="manual-icon">â¤ï¸</span> <strong>ì“°ë‹¤ë“¬ê¸°:</strong> í•˜íŠ¸ê°€ ë–´ì„ ë•Œ í«ì„ í´ë¦­í•˜ë©´ ëˆì„ ë²•ë‹ˆë‹¤!</div>
            <div class="manual-item"><span class="manual-icon">ğŸª‘</span> <strong>ê¾¸ë¯¸ê¸°:</strong> ëˆì„ ëª¨ì•„ ê°€êµ¬ë¥¼ ì§ì ‘ ê·¸ë ¤ì„œ ë°°ì¹˜í•˜ì„¸ìš”.</div>
            <button id="btn-close-help" onclick="toggleHelp()">ë‹«ê¸°</button>
        </div>

        <div id="stats-bar">
            <div class="stat-box">ğŸ– <progress id="hunger-bar" value="100" max="100"></progress></div>
            <div class="stat-box">âœ¨ <progress id="clean-bar" value="100" max="100"></progress></div>
            <div class="stat-box" style="font-size: 20px;">ğŸ’° <span id="money-display">0</span> G</div>
            <button id="btn-help" onclick="toggleHelp()">â“</button>
        </div>

        <div id="room-container">
            <canvas id="roomCanvas" width="600" height="400"></canvas>
        </div>

        <div id="actions-bar">
            <button class="action-btn" id="btn-feed" onclick="spawnFood()">ğŸ– ë°¥ ì¤€ë¹„ (ë“œë˜ê·¸)</button>
            <button class="action-btn" id="btn-buy" onclick="startFurnitureMode()">ğŸª‘ ê°€êµ¬ ë§Œë“¤ê¸° (50G)</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    //  ì „ì—­ ë³€ìˆ˜
    // ==========================================
    let gameState = {
        pet: null,
        stats: { hunger: 100, cleanliness: 100, lastUpdated: Date.now() },
        money: 100,
        furniture: []
    };

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¡œë“œ
    const savedData = localStorage.getItem('pixelPetV4');
    if (savedData) {
        gameState = JSON.parse(savedData);
        const now = Date.now();
        const elapsedSecs = (now - gameState.stats.lastUpdated) / 1000;
        gameState.stats.hunger = Math.max(0, gameState.stats.hunger - elapsedSecs * 0.1);
        gameState.stats.cleanliness = Math.max(0, gameState.stats.cleanliness - elapsedSecs * 0.05);
        gameState.stats.lastUpdated = now;
        if(gameState.pet) { gameState.pet.state = 'IDLE'; gameState.pet.stateTimer = 0; }
    }

    let isFurnitureMode = false;
    let grabbedObject = null;
    let grabbedType = null;
    let dragOffset = {x:0, y:0};
    let spawnedFood = null;

    // ìš•ì¡° ìœ„ì¹˜ (ê³ ì •)
    const bathtub = { x: 480, y: 300, width: 100, height: 60 };

    // ==========================================
    //  1. ì—ë””í„° ì—”ì§„
    // ==========================================
    const CANVAS_SIZE = 64;
    const paletteColors = ['#000000', '#1D2B53', '#7E2553', '#008751', '#AB5236', '#5F574F', '#C2C3C7', '#FFF1E8', '#FF004D', '#FFA300', '#FFEC27', '#00E436', '#29ADFF', '#83769C', '#FF77A8', '#FFCCAA'];
    const editorCanvas = document.getElementById('editorCanvas');
    const ctxEditor = editorCanvas.getContext('2d', { willReadFrequently: true });
    let selectedColor = paletteColors[0], isDrawing = false, currentTool = 'pencil', historyStack = [];

    function saveState() { historyStack.push(ctxEditor.getImageData(0, 0, CANVAS_SIZE, CANVAS_SIZE)); if(historyStack.length>20)historyStack.shift(); }
    function undo() { if(historyStack.length>0) ctxEditor.putImageData(historyStack.pop(),0,0); }
    function setTool(tool) { currentTool = tool; document.querySelectorAll('.tool-btn').forEach(btn=>btn.classList.remove('active')); document.getElementById('btn-'+tool).classList.add('active'); }
    const paletteDiv = document.getElementById('palette');
    paletteColors.forEach((color,i)=>{ const btn=document.createElement('div'); btn.className='color-btn'+(i===0?' active':''); btn.style.backgroundColor=color; btn.onclick=()=>{if(currentTool==='eraser')setTool('pencil');document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');selectedColor=color;}; paletteDiv.appendChild(btn); });
    function clearCanvas() { saveState(); ctxEditor.clearRect(0,0,CANVAS_SIZE,CANVAS_SIZE); }
    function getPos(e) { const r=editorCanvas.getBoundingClientRect(); const cx=e.touches?e.touches[0].clientX:e.clientX; const cy=e.touches?e.touches[0].clientY:e.clientY; return {x:Math.floor((cx-r.left)*(CANVAS_SIZE/r.width)),y:Math.floor((cy-r.top)*(CANVAS_SIZE/r.height))}; }
    function drawPixel(e) { if(e.cancelable)e.preventDefault(); const {x,y}=getPos(e); if(currentTool==='eraser'||e.buttons===2)ctxEditor.clearRect(x,y,1,1); else if(currentTool==='pencil'){ctxEditor.fillStyle=selectedColor;ctxEditor.fillRect(x,y,1,1);} }
    function floodFill(sx,sy,fc){ const id=ctxEditor.getImageData(0,0,CANVAS_SIZE,CANVAS_SIZE),d=id.data,sp=(sy*CANVAS_SIZE+sx)*4,[sr,sg,sb,sa]=[d[sp],d[sp+1],d[sp+2],d[sp+3]]; const r=parseInt(fc.slice(1,3),16),g=parseInt(fc.slice(3,5),16),b=parseInt(fc.slice(5,7),16); if(sr===r&&sg===g&&sb===b&&sa===255)return; const st=[[sx,sy]]; while(st.length){const [x,y]=st.pop(),p=(y*CANVAS_SIZE+x)*4; if(x<0||x>=CANVAS_SIZE||y<0||y>=CANVAS_SIZE)continue; if(d[p]===sr&&d[p+1]===sg&&d[p+2]===sb&&d[p+3]===sa){d[p]=r;d[p+1]=g;d[p+2]=b;d[p+3]=255; st.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);}} ctxEditor.putImageData(id,0,0); }
    function startDraw(e) { saveState(); if(currentTool==='bucket')floodFill(getPos(e).x,getPos(e).y,selectedColor); else{isDrawing=true;drawPixel(e);} }
    editorCanvas.addEventListener('mousedown', startDraw); editorCanvas.addEventListener('mousemove', e=>{if(isDrawing)drawPixel(e)}); window.addEventListener('mouseup', ()=>isDrawing=false); editorCanvas.addEventListener('contextmenu', e=>e.preventDefault());
    editorCanvas.addEventListener('touchstart', startDraw, {passive:false}); editorCanvas.addEventListener('touchmove', e=>{if(isDrawing)drawPixel(e)}, {passive:false}); window.addEventListener('touchend', ()=>isDrawing=false);

    // ==========================================
    //  2. í« AI & ìƒí˜¸ì‘ìš©
    // ==========================================
    const roomCanvas = document.getElementById('roomCanvas');
    const ctxRoom = roomCanvas.getContext('2d');

    function savePet() {
        if (gameState.pet) { alert("ì´ë¯¸ í«ì´ ìˆìŠµë‹ˆë‹¤!"); return; }
        const dataURL = editorCanvas.toDataURL();
        gameState.pet = {
            imageSrc: dataURL, x: 250, y: 150, width: 100, height: 100, imgObj: new Image(),
            state: 'IDLE', stateTimer: 100, targetX: 0, targetY: 0,
            isHeartActive: false, heartTimer: 0 
        };
        gameState.pet.imgObj.src = dataURL;
        clearCanvas(); saveGame();
    }

    function updatePetAI() {
        const p = gameState.pet;
        if (!p || grabbedObject === p) return;

        if (!p.isHeartActive && Math.random() < 0.002) { 
            p.isHeartActive = true; p.heartTimer = 300; 
        }
        if (p.isHeartActive) {
            p.heartTimer--; if (p.heartTimer <= 0) p.isHeartActive = false;
        }

        p.stateTimer--;
        if (p.state === 'IDLE') {
            if (p.stateTimer <= 0) {
                const rand = Math.random();
                if (rand < 0.6) { p.state='WALK'; p.stateTimer=200; p.targetX=Math.random()*(roomCanvas.width-p.width); p.targetY=Math.random()*(roomCanvas.height-p.height); }
                else if (rand < 0.9) { p.state='IDLE'; p.stateTimer=100; }
                else { p.state='SLEEP'; p.stateTimer=400; }
            }
        } else if (p.state === 'WALK') {
            const dx = p.targetX - p.x, dy = p.targetY - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 5 || p.stateTimer <= 0) p.state = 'IDLE';
            else { let speed = 2 * ((gameState.stats.hunger+50)/150); p.x += (dx/dist)*speed; p.y += (dy/dist)*speed; }
        } else if (p.state === 'SLEEP') {
            if (p.stateTimer <= 0) p.state = 'IDLE';
        } else if (p.state === 'WASHING') {
            if (p.stateTimer <= 0) {
                p.state = 'IDLE';
                if(gameState.stats.cleanliness < 100) {
                    gameState.stats.cleanliness = 100; gameState.money += 30; statusEffect('ğŸ› ëª©ìš• ë! (+30G)'); saveGame();
                }
            }
        }
    }

    // ==========================================
    //  3. ì…ë ¥ ë° ë¡œì§
    // ==========================================
    function spawnFood() { if(spawnedFood) return; spawnedFood = { x: 50, y: 320, width: 40, height: 40, emoji: 'ğŸ–' }; }

    function handleInput(e) {
        const r = roomCanvas.getBoundingClientRect();
        const mx = (e.touches?e.touches[0].clientX:e.clientX) - r.left;
        const my = (e.touches?e.touches[0].clientY:e.clientY) - r.top;

        if (e.type === 'mousedown' || e.type === 'touchstart') {
            if(e.cancelable) e.preventDefault();
            if (spawnedFood && isHit(mx, my, spawnedFood)) {
                grabbedObject = spawnedFood; grabbedType = 'FOOD'; dragOffset = {x: mx - spawnedFood.x, y: my - spawnedFood.y}; return;
            }
            if (gameState.pet && isHit(mx, my, gameState.pet)) {
                if (gameState.pet.isHeartActive) {
                    gameState.pet.isHeartActive = false; gameState.money += 50; statusEffect('â¤ï¸ ì‚¬ë‘í•´! (+50G)'); saveGame(); return;
                }
                grabbedObject = gameState.pet; grabbedType = 'PET'; dragOffset = {x: mx - gameState.pet.x, y: my - gameState.pet.y}; gameState.pet.state = 'DRAGGED'; return;
            }
            for (let i = gameState.furniture.length - 1; i >= 0; i--) {
                const f = gameState.furniture[i];
                if (isHit(mx, my, f)) {
                    grabbedObject = f; grabbedType = 'FURNITURE'; dragOffset = {x: mx - f.x, y: my - f.y}; gameState.furniture.push(gameState.furniture.splice(i, 1)[0]); return;
                }
            }
        } else if (e.type === 'mousemove' || e.type === 'touchmove') {
            if (grabbedObject) { if(e.cancelable) e.preventDefault(); grabbedObject.x = mx - dragOffset.x; grabbedObject.y = my - dragOffset.y; }
        } else if (e.type === 'mouseup' || e.type === 'touchend') {
            if (grabbedObject) {
                if (grabbedType === 'FOOD' && gameState.pet && checkCollision(grabbedObject, gameState.pet)) {
                    if (gameState.stats.hunger < 100) { gameState.stats.hunger = Math.min(100, gameState.stats.hunger + 30); gameState.money += 10; statusEffect('ğŸ– ëƒ ëƒ ! (+10G)'); spawnedFood = null; } 
                    else { statusEffect('ë°°ë¶ˆëŸ¬ìš”!'); }
                }
                if (grabbedType === 'PET' && checkCollision(grabbedObject, bathtub)) {
                    gameState.pet.state = 'WASHING'; gameState.pet.stateTimer = 120; gameState.pet.x = bathtub.x + 10; gameState.pet.y = bathtub.y - 15;
                } else if (grabbedType === 'PET') { gameState.pet.state = 'IDLE'; }
                grabbedObject = null; grabbedType = null; saveGame();
            }
        }
    }

    function isHit(mx, my, obj) { return mx > obj.x && mx < obj.x + obj.width && my > obj.y && my < obj.y + obj.height; }
    function checkCollision(obj1, obj2) { return obj1.x < obj2.x + obj2.width && obj1.x + obj1.width > obj2.x && obj1.y < obj2.y + obj2.height && obj1.y + obj1.height > obj2.y; }

    roomCanvas.addEventListener('mousedown', handleInput); roomCanvas.addEventListener('mousemove', handleInput); window.addEventListener('mouseup', handleInput);
    roomCanvas.addEventListener('touchstart', handleInput, {passive:false}); roomCanvas.addEventListener('touchmove', handleInput, {passive:false}); window.addEventListener('touchend', handleInput);

    // ==========================================
    //  4. UI ë° ë Œë”ë§
    // ==========================================
    function startFurnitureMode() { if(gameState.money<50){alert("ëˆ ë¶€ì¡±");return;} if(!gameState.pet){alert("í« ë¨¼ì €!");return;} gameState.money-=50; updateUI(); isFurnitureMode=true; document.getElementById('editor-title').innerText='ğŸª‘ ê°€êµ¬ ëª¨ë“œ'; document.getElementById('btn-save-pet').style.display='none'; document.getElementById('btn-save-furniture').style.display='inline-block'; document.getElementById('btn-cancel-furniture').style.display='inline-block'; clearCanvas(); }
    function saveFurniture(){ const d=editorCanvas.toDataURL(); gameState.furniture.push({imageSrc:d, x:200, y:200, width:80, height:80, imgObj:new Image()}); gameState.furniture[gameState.furniture.length-1].imgObj.src=d; alert("ê°€êµ¬ ìƒì„±!"); cancelFurnitureMode(); }
    function cancelFurnitureMode(){ isFurnitureMode=false; document.getElementById('editor-title').innerText='ğŸ¨ í« ê·¸ë¦¬ê¸°'; document.getElementById('btn-save-pet').style.display='inline-block'; document.getElementById('btn-save-furniture').style.display='none'; document.getElementById('btn-cancel-furniture').style.display='none'; clearCanvas(); saveGame(); }
    
    function statusEffect(msg) { const ef=document.createElement('div'); ef.innerText=msg; ef.style.position='absolute'; ef.style.left=(gameState.pet.x+40)+'px'; ef.style.top=(gameState.pet.y)+'px'; ef.style.color='#fff'; ef.style.fontWeight='bold'; ef.style.textShadow='2px 2px 0 #000'; ef.style.transition='1s'; document.getElementById('room-container').appendChild(ef); setTimeout(()=>{ef.style.transform='translateY(-50px)';ef.style.opacity=0;},50); setTimeout(()=>ef.remove(),1050); }
    function saveGame(){ gameState.stats.lastUpdated=Date.now(); localStorage.setItem('pixelPetV4',JSON.stringify(gameState)); updateUI(); }
    function updateUI(){ document.getElementById('hunger-bar').value=gameState.stats.hunger; document.getElementById('clean-bar').value=gameState.stats.cleanliness; document.getElementById('money-display').innerText=gameState.money; }
    
    function toggleHelp() {
        const modal = document.getElementById('help-modal');
        modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
    }

    // ì´ë¯¸ì§€ ë¡œë“œ
    if (gameState.pet) { gameState.pet.imgObj = new Image(); gameState.pet.imgObj.src = gameState.pet.imageSrc; }
    gameState.furniture.forEach(f => { f.imgObj = new Image(); f.imgObj.src = f.imageSrc; });

    // ì²˜ìŒ ì‹¤í–‰ ì‹œ í«ì´ ì—†ìœ¼ë©´ ë„ì›€ë§ ë„ìš°ê¸°
    if (!gameState.pet) toggleHelp();

    // ì§ì ‘ ê·¸ë¦¬ëŠ” ìš•ì¡° í•¨ìˆ˜
    function drawBathtub(ctx, x, y, w, h) {
        // ë‹¤ë¦¬
        ctx.fillStyle = '#b2bec3';
        ctx.fillRect(x + 10, y + h - 5, 10, 5);
        ctx.fillRect(x + w - 20, y + h - 5, 10, 5);
        
        // ë³¸ì²´ (ë„ê¸°)
        ctx.fillStyle = '#f5f6fa'; // í°ìƒ‰ì— ê°€ê¹Œìš´ íšŒìƒ‰
        ctx.fillRect(x, y, w, h - 5);
        ctx.strokeStyle = '#dcdde1';
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h - 5);

        // ë¬¼
        ctx.fillStyle = '#4bcffa'; // ë°ì€ íŒŒë‘
        ctx.fillRect(x + 5, y + 10, w - 10, h - 25);
        
        // ê±°í’ˆ (ì¥ì‹)
        ctx.fillStyle = 'white';
        ctx.beginPath(); ctx.arc(x + 15, y + 15, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x + 30, y + 20, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x + w - 15, y + 12, 3, 0, Math.PI*2); ctx.fill();
    }

    function gameLoop() {
        ctxRoom.clearRect(0, 0, roomCanvas.width, roomCanvas.height);

        if (gameState.pet) {
            gameState.stats.hunger = Math.max(0, gameState.stats.hunger - 0.01);
            gameState.stats.cleanliness = Math.max(0, gameState.stats.cleanliness - 0.005);
            updateUI();
            updatePetAI();
        }

        // 1. ìš•ì¡° ê·¸ë¦¬ê¸° (ì½”ë“œë¡œ ê·¸ë¦¼)
        drawBathtub(ctxRoom, bathtub.x, bathtub.y, bathtub.width, bathtub.height);

        // 2. ê°€êµ¬ ê·¸ë¦¬ê¸°
        gameState.furniture.forEach(f => ctxRoom.drawImage(f.imgObj, f.x, f.y, f.width, f.height));

        // 3. í« ê·¸ë¦¬ê¸°
        if (gameState.pet) {
            const p = gameState.pet;
            if (p.state !== 'DRAGGED' && p.state !== 'WASHING') {
                ctxRoom.fillStyle = 'rgba(0,0,0,0.2)'; ctxRoom.beginPath();
                ctxRoom.ellipse(p.x + p.width/2, p.y + p.height-5, p.width/3, 8, 0, 0, Math.PI*2); ctxRoom.fill();
            }
            
            if (p.state === 'WASHING') {
                const shake = Math.sin(Date.now() / 100) * 3;
                ctxRoom.drawImage(p.imgObj, p.x + shake, p.y + 10, p.width, p.height); // ë¬¼ì†ì— ì ê¸´ ëŠë‚Œ
                // ë¹„ëˆ„ ê±°í’ˆ íŒŒí‹°í´
                if(Math.random() < 0.1) {
                    ctxRoom.fillStyle = 'white'; ctxRoom.beginPath();
                    ctxRoom.arc(p.x + Math.random()*p.width, p.y + Math.random()*p.height, Math.random()*4, 0, Math.PI*2); ctxRoom.fill();
                }
            } else {
                ctxRoom.drawImage(p.imgObj, p.x, p.y, p.width, p.height);
            }

            ctxRoom.font = "24px serif";
            if (p.isHeartActive) ctxRoom.fillText('â¤ï¸', p.x + p.width/2 - 10, p.y - 10);
            else if (p.state === 'SLEEP') ctxRoom.fillText('ğŸ’¤', p.x + p.width, p.y);
            else if (gameState.stats.hunger < 30) ctxRoom.fillText('ğŸ–', p.x + p.width, p.y);
            else if (gameState.stats.cleanliness < 30) ctxRoom.fillText('ğŸ’©', p.x + p.width, p.y);
        }

        // 4. ìŒì‹ ê·¸ë¦¬ê¸°
        if (spawnedFood) {
            ctxRoom.font = "40px serif";
            ctxRoom.fillText(spawnedFood.emoji, spawnedFood.x, spawnedFood.y + 35);
        }

        requestAnimationFrame(gameLoop);
    }

    updateUI(); gameLoop(); setInterval(saveGame, 5000);
</script>
</body>
</html>